#version 330
#extension GL_ARB_shading_language_420pack : require
#extension GL_ARB_explicit_uniform_location : require
struct LightSource
{
    vec3 pos;
    vec3 ldir;
    vec3 amb;
    vec3 dif;
    vec3 spec;
};

uniform float smoothTimestep;
uniform float vpWidth;
uniform float vpHeight;
uniform sampler2D depthMap;

uniform mat4 view;
uniform LightSource light;

in vec2 fragTexCoord;
out vec4 fragColor;

float gaussianScale = 1.0;
float gaussian[] = {0.000000,	0.000001,	0.000005,	0.000014,	0.000032,	0.000059,	0.000085,	0.000097,	0.000085,	0.000059,	0.000032,	0.000014,	0.000005,	0.000001,	0.000000,
                    0.000001,	0.000006,	0.000022,	0.000067,	0.000158,	0.000291,	0.000420,	0.000474,	0.000420,	0.000291,	0.000158,	0.000067,	0.000022,	0.000006,	0.000001,
                    0.000005,	0.000022,	0.000085,	0.000257,	0.000607,	0.001119,	0.001615,	0.001826,	0.001615,	0.001119,	0.000607,	0.000257,	0.000085,	0.000022,	0.000005,
                    0.000014,	0.000067,	0.000257,	0.000775,	0.001826,	0.003369,	0.004864,	0.005497,	0.004864,	0.003369,	0.001826,	0.000775,	0.000257,	0.000067,	0.000014,
                    0.000032,	0.000158,	0.000607,	0.001826,	0.004304,	0.007938,	0.011460,	0.012953,	0.011460,	0.007938,	0.004304,	0.001826,	0.000607,	0.000158,	0.000032,
                    0.000059,	0.000291,	0.001119,	0.003369,	0.007938,	0.014641,	0.021138,	0.023891,	0.021138,	0.014641,	0.007938,	0.003369,	0.001119,	0.000291,	0.000059,
                    0.000085,	0.000420,	0.001615,	0.004864,	0.011460,	0.021138,	0.030519,	0.034494,	0.030519,	0.021138,	0.011460,	0.004864,	0.001615,	0.000420,	0.000085,
                    0.000097,	0.000474,	0.001826,	0.005497,	0.012953,	0.023891,	0.034494,	0.038986,	0.034494,	0.023891,	0.012953,	0.005497,	0.001826,	0.000474,	0.000097,
                    0.000085,	0.000420,	0.001615,	0.004864,	0.011460,	0.021138,	0.030519,	0.034494,	0.030519,	0.021138,	0.011460,	0.004864,	0.001615,	0.000420,	0.000085,
                    0.000059,	0.000291,	0.001119,	0.003369,	0.007938,	0.014641,	0.021138,	0.023891,	0.021138,	0.014641,	0.007938,	0.003369,	0.001119,	0.000291,	0.000059,
                    0.000032,	0.000158,	0.000607,	0.001826,	0.004304,	0.007938,	0.011460,	0.012953,	0.011460,	0.007938,	0.004304,	0.001826,	0.000607,	0.000158,	0.000032,
                    0.000014,	0.000067,	0.000257,	0.000775,	0.001826,	0.003369,	0.004864,	0.005497,	0.004864,	0.003369,	0.001826,	0.000775,	0.000257,	0.000067,	0.000014,
                    0.000005,	0.000022,	0.000085,	0.000257,	0.000607,	0.001119,	0.001615,	0.001826,	0.001615,	0.001119,	0.000607,	0.000257,	0.000085,	0.000022,	0.000005,
                    0.000001,	0.000006,	0.000022,	0.000067,	0.000158,	0.000291,	0.000420,	0.000474,	0.000420,	0.000291,	0.000158,	0.000067,	0.000022,	0.000006,	0.000001,
                    0.000000,	0.000001,	0.000005,	0.000014,	0.000032,	0.000059,	0.000085,	0.000097,	0.000085,	0.000059,	0.000032,	0.000014,	0.000005,	0.000001,	0.000000};


/*float gaussianScale = 1.0/16.0;

float gaussian[] = {1,2,1,
                    2,4,2,
                    1,2,1};
*/
float convolve(vec2 fragPos,vec2 dxTex)
{
    float sum = 0.0;
    for(int y=-8;y<=8;y++)
    {
        for(int x=-8;x<=8;x++)
        {
            sum += texture(depthMap,fragPos+vec2(x*dxTex.x,y*dxTex.y),0).x;
        }
    }
    //return 10.0;
    return gaussianScale*sum;
}

void main()
{
    vec2 dxTex;
    dxTex.x = 1.0/textureSize(depthMap,0).x;
    dxTex.y = 1.0/textureSize(depthMap,0).y;
    gl_FragDepth = convolve(fragTexCoord,dxTex);
}
